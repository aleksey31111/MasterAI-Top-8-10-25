{% extends 'finances/base.html' %}

{% block title %}–ü–æ–∏—Å–∫ –æ–ø–µ—Ä–∞—Ü–∏–π{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">üîç –ü–æ–∏—Å–∫ –æ–ø–µ—Ä–∞—Ü–∏–π –∑–∞ –ø–µ—Ä–∏–æ–¥</h1>
    
    <div class="row">
        <div class="col-md-8 mx-auto">
            <!-- –§–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ -->
            <div class="card mb-4">
                <div class="card-body">
                    <form method="get" action="{% url 'search' %}" class="row g-3">
                        <div class="col-md-5">
                            <label for="start_date" class="form-label">–ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞</label>
                            <input type="text"
                                   class="form-control"
                                   id="start_date"
                                   name="start_date"
                                   value="{{ start_date }}"
                                   placeholder="–î–î.–ú–ú.–ì–ì–ì–ì"
                                   pattern="\d{2}\.\d{2}\.\d{4}"
                                   title="–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì, –Ω–∞–ø—Ä–∏–º–µ—Ä 01.02.2026"
                                   required>
                            <div class="form-text">–§–æ—Ä–º–∞—Ç: –î–î.–ú–ú.–ì–ì–ì–ì (–Ω–∞–ø—Ä–∏–º–µ—Ä, 01.02.2026)</div>
                        </div>
                        <div class="col-md-5">
                            <label for="end_date" class="form-label">–ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞</label>
                            <input type="text"
                                   class="form-control"
                                   id="end_date"
                                   name="end_date"
                                   value="{{ end_date }}"
                                   placeholder="–î–î.–ú–ú.–ì–ì–ì–ì"
                                   pattern="\d{2}\.\d{2}\.\d{4}"
                                   title="–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì, –Ω–∞–ø—Ä–∏–º–µ—Ä 31.12.2026"
                                   required>
                            <div class="form-text">–§–æ—Ä–º–∞—Ç: –î–î.–ú–ú.–ì–ì–ì–ì (–Ω–∞–ø—Ä–∏–º–µ—Ä, 31.12.2026)</div>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-search"></i> –ù–∞–π—Ç–∏
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
            {% if request.GET.start_date %}
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥ —Å {{ start_date }} –ø–æ {{ end_date }}
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if operations %}
                            <!-- –ö—Ä–∞—Ç–∫–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥ -->
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h6 class="card-title text-muted">–î–æ—Ö–æ–¥—ã</h6>
                                            <h4 class="text-success mb-0">{{ total_income|floatformat:2 }} ‚ÇΩ</h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h6 class="card-title text-muted">–†–∞—Å—Ö–æ–¥—ã</h6>
                                            <h4 class="text-danger mb-0">{{ total_expense|floatformat:2 }} ‚ÇΩ</h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h6 class="card-title text-muted">–ë–∞–ª–∞–Ω—Å</h6>
                                            <h4 class="{% if balance >= 0 %}text-success{% else %}text-danger{% endif %} mb-0">
                                                {{ balance|floatformat:2 }} ‚ÇΩ
                                            </h4>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <p class="text-muted">
                                –ù–∞–π–¥–µ–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–π: <strong>{{ operations|length }}</strong>
                            </p>

                            <!-- –¢–∞–±–ª–∏—Ü–∞ –æ–ø–µ—Ä–∞—Ü–∏–π -->
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>–î–∞—Ç–∞</th>
                                            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                            <th>–°—É–º–º–∞</th>
                                            <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for op in operations %}
                                            <tr>
                                                <td>{{ op.date }}</td>
                                                <td>
                                                    <span class="badge {% if op.category == '–¥–æ—Ö–æ–¥' %}bg-success{% else %}bg-danger{% endif %}">
                                                        {{ op.category }}
                                                    </span>
                                                </td>
                                                <td class="{% if op.category == '–¥–æ—Ö–æ–¥' %}text-success{% else %}text-danger{% endif %} fw-bold">
                                                    {{ op.amount|floatformat:2 }} ‚ÇΩ
                                                </td>
                                                <td>{{ op.description }}</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-info-circle"></i>
                                –ó–∞ –ø–µ—Ä–∏–æ–¥ —Å <strong>{{ start_date }}</strong> –ø–æ <strong>{{ end_date }}</strong>
                                –æ–ø–µ—Ä–∞—Ü–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.
                                <br>
                                <a href="{% url 'add_operation' %}" class="alert-link mt-2 d-inline-block">
                                    ‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –æ–ø–µ—Ä–∞—Ü–∏—é
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% else %}
                <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –ø–æ—Å–µ—â–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
                <div class="alert alert-info">
                    <i class="fas fa-calendar-alt"></i>
                    –£–∫–∞–∂–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –ø–æ–∏—Å–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π. –î–∞—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ <strong>–î–î.–ú–ú.–ì–ì–ì–ì</strong>.
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞—Ç –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
    document.querySelector('form').addEventListener('submit', function(e) {
        const startDate = document.getElementById('start_date').value.trim();
        const endDate = document.getElementById('end_date').value.trim();

        const dateRegex = /^\d{2}\.\d{2}\.\d{4}$/;

        if (!dateRegex.test(startDate)) {
            e.preventDefault();
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞—á–∞–ª—å–Ω—É—é –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì');
            return;
        }

        if (!dateRegex.test(endDate)) {
            e.preventDefault();
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ–Ω–µ—á–Ω—É—é –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì');
            return;
        }

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –Ω–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ –Ω–µ –ø–æ–∑–∂–µ –∫–æ–Ω–µ—á–Ω–æ–π
        const [startDay, startMonth, startYear] = startDate.split('.');
        const [endDay, endMonth, endYear] = endDate.split('.');

        const start = new Date(startYear, startMonth - 1, startDay);
        const end = new Date(endYear, endMonth - 1, endDay);

        if (start > end) {
            e.preventDefault();
            alert('–ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–∑–∂–µ –∫–æ–Ω–µ—á–Ω–æ–π –¥–∞—Ç—ã');
        }
    });

    // –ê–≤—Ç–æ–ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç—ã –ø—Ä–∏ –∫–ª–∏–∫–µ
    document.addEventListener('DOMContentLoaded', function() {
        const startInput = document.getElementById('start_date');
        const endInput = document.getElementById('end_date');

        // –ï—Å–ª–∏ –ø–æ–ª—è –ø—É—Å—Ç—ã–µ, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –¥–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        if (!startInput.value) {
            // –ü–µ—Ä–≤–æ–µ —á–∏—Å–ª–æ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const day = String(firstDay.getDate()).padStart(2, '0');
            const month = String(firstDay.getMonth() + 1).padStart(2, '0');
            const year = firstDay.getFullYear();
            startInput.value = `${day}.${month}.${year}`;
        }

        if (!endInput.value) {
            // –°–µ–≥–æ–¥–Ω—è—à–Ω—è—è –¥–∞—Ç–∞
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            endInput.value = `${day}.${month}.${year}`;
        }
    });
</script>
{% endblock %}