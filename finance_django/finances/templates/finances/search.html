{% extends 'finances/base.html' %}

{% block title %}–ü–æ–∏—Å–∫ –æ–ø–µ—Ä–∞—Ü–∏–π{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">üîç –ü–æ–∏—Å–∫ –æ–ø–µ—Ä–∞—Ü–∏–π –∑–∞ –ø–µ—Ä–∏–æ–¥</h1>
    
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card mb-4">
                <div class="card-body">
                    <form method="get" action="{% url 'search' %}" class="row g-3">
                        <div class="col-md-5">
                            <label for="start_date" class="form-label">–ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="start_date" 
                                   name="start_date" 
                                   value="{{ start_date }}" 
                                   placeholder="–î–î.–ú–ú.–ì–ì–ì–ì"
                                   required>
                        </div>
                        <div class="col-md-5">
                            <label for="end_date" class="form-label">–ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="end_date" 
                                   name="end_date" 
                                   value="{{ end_date }}" 
                                   placeholder="–î–î.–ú–ú.–ì–ì–ì–ì"
                                   required>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                –ù–∞–π—Ç–∏
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
            {% if request.GET.start_date %}
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞</h5>
                    </div>
                    <div class="card-body">
                        {% if operations %}
                            <p class="text-muted">
                                –ù–∞–π–¥–µ–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–π: <strong>{{ operations|length }}</strong>
                            </p>
                            
                            {% with total_income=0 total_expense=0 %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>–î–∞—Ç–∞</th>
                                                <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                                <th>–°—É–º–º–∞</th>
                                                <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for op in operations %}
                                                <tr>
                                                    <td>{{ op.date }}</td>
                                                    <td>
                                                        <span class="badge {% if op.category == '–¥–æ—Ö–æ–¥' %}bg-success{% else %}bg-danger{% endif %}">
                                                            {{ op.category }}
                                                        </span>
                                                    </td>
                                                    <td class="{% if op.category == '–¥–æ—Ö–æ–¥' %}income{% else %}expense{% endif %} fw-bold">
                                                        {{ op.amount|floatformat:2 }} ‚ÇΩ
                                                    </td>
                                                    <td>{{ op.description }}</td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% endwith %}
                            
                            <!-- –ò—Ç–æ–≥–∏ –∑–∞ –ø–µ—Ä–∏–æ–¥ -->
                            <div class="row mt-4">
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h6 class="card-title">–î–æ—Ö–æ–¥—ã</h6>
                                            <p class="card-text h5 text-success">
                                                {% for op in operations %}
                                                    {% if op.category == '–¥–æ—Ö–æ–¥' %}
                                                        {{ op.amount|floatformat:2 }} ‚ÇΩ
                                                    {% endif %}
                                                {% endfor %}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h6 class="card-title">–†–∞—Å—Ö–æ–¥—ã</h6>
                                            <p class="card-text h5 text-danger">
                                                {% for op in operations %}
                                                    {% if op.category == '—Ä–∞—Å—Ö–æ–¥' %}
                                                        {{ op.amount|floatformat:2 }} ‚ÇΩ
                                                    {% endif %}
                                                {% endfor %}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h6 class="card-title">–ë–∞–ª–∞–Ω—Å</h6>
                                            <p class="card-text h5 text-info">
                                                {% for op in operations %}
                                                    {% if op.category == '–¥–æ—Ö–æ–¥' %}
                                                        {{ op.amount|floatformat:2 }} ‚ÇΩ
                                                    {% else %}
                                                        -{{ op.amount|floatformat:2 }} ‚ÇΩ
                                                    {% endif %}
                                                {% endfor %}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="alert alert-info mb-0">
                                –ó–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –æ–ø–µ—Ä–∞—Ü–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞—Ç –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
    document.querySelector('form').addEventListener('submit', function(e) {
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        
        const dateRegex = /^\d{2}\.\d{2}\.\d{4}$/;
        
        if (!dateRegex.test(startDate) || !dateRegex.test(endDate)) {
            e.preventDefault();
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì');
        }
    });
</script>
{% endblock %}
{% endblock %}